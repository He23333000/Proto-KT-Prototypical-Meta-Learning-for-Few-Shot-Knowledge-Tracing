\documentclass[tikz,border=10pt]{standalone}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows,positioning,fit,calc,backgrounds}
\usepackage{amsmath}
\usepackage{amssymb}

\begin{document}

% Define colors
\definecolor{inputblue}{RGB}{100,149,237}
\definecolor{protogreen}{RGB}{60,179,113}
\definecolor{metaorange}{RGB}{255,140,0}
\definecolor{adaptpurple}{RGB}{147,112,219}
\definecolor{lightgray}{RGB}{240,240,240}

% Define styles
\tikzstyle{databox} = [rectangle, draw, fill=inputblue!20, text width=3cm, text centered, rounded corners, minimum height=1.2cm, thick]
\tikzstyle{protobox} = [rectangle, draw, fill=protogreen!20, text width=3cm, text centered, rounded corners, minimum height=1.2cm, thick]
\tikzstyle{metabox} = [rectangle, draw, fill=metaorange!20, text width=3cm, text centered, rounded corners, minimum height=1.2cm, thick]
\tikzstyle{adaptbox} = [rectangle, draw, fill=adaptpurple!20, text width=3cm, text centered, rounded corners, minimum height=1.2cm, thick]
\tikzstyle{arrow} = [thick,->,>=stealth]
\tikzstyle{dashedarrow} = [thick,->,>=stealth,dashed]

\begin{tikzpicture}[node distance=2cm, auto]

% Title
\node[text width=15cm, text centered, font=\Large\bfseries] (title) at (0,8) {Proto-KT: Prototypical Knowledge Tracing with Meta-Learning};

% Panel A: Overview
\node[font=\large\bfseries, anchor=west] (panelA) at (-7.5,6.5) {(A) Meta-Learning Pipeline};

\node[databox] (student) at (-6,5) {Student\\Interaction\\Data\\$\mathcal{D}_i$};
\node[protobox, right=1.5cm of student] (encoder) {Context\\Encoder\\(SAKT)};
\node[protobox, right=1.5cm of encoder] (paramgen) {Parameter\\Generator\\(Prototypes)};
\node[metabox, right=1.5cm of paramgen] (maml) {MAML\\Adaptation\\(Inner Loop)};

\draw[arrow] (student) -- (encoder);
\draw[arrow] (encoder) -- node[above] {$\mathbf{c}$} (paramgen);
\draw[arrow] (paramgen) -- node[above] {$\theta_{\text{init}}$} (maml);
\draw[arrow] (maml) -- ++(2,0) node[right] {$\theta'$ (adapted)};

% Panel B: Context Encoder & Prototypes
\node[font=\large\bfseries, anchor=west] (panelB) at (-7.5,2.5) {(B) Context Encoding \& Prototype Memory};

\begin{scope}[shift={(0,-2)}]
    % Support set input
    \node[databox, text width=2.5cm] (support) at (-6,1.5) {Support Set\\$\mathcal{S}_i$\\$(x_1, y_1), \ldots$};
    
    % SAKT Encoder
    \node[protobox, text width=2.5cm, right=1cm of support] (sakt) {SAKT\\Encoder\\$f_\phi$};
    
    % Mean pooling
    \node[protobox, text width=2cm, right=1cm of sakt] (meanpool) {Mean\\Pooling};
    
    % Context vector
    \node[protobox, text width=2cm, right=1cm of meanpool] (context) {Context\\$\mathbf{c} \in \mathbb{R}^d$};
    
    % Prototype memory
    \node[protobox, text width=6cm, minimum height=2cm, below=0.8cm of context] (protomem) {
        \textbf{Prototype Memory Bank}\\[0.2cm]
        $\mathbf{P} = [\mathbf{p}_1, \mathbf{p}_2, \ldots, \mathbf{p}_K] \in \mathbb{R}^{K \times d}$\\
        $\mathbf{\Phi} = [\boldsymbol{\phi}_1, \boldsymbol{\phi}_2, \ldots, \boldsymbol{\phi}_K] \in \mathbb{R}^{K \times |\theta|}$
    };
    
    % Attention
    \node[metabox, text width=4cm, below=0.8cm of protomem] (attention) {
        Attention Weights\\[0.1cm]
        $\boldsymbol{\alpha} = \text{softmax}(\mathbf{c}^\top \mathbf{P}^\top)$
    };
    
    % Arrows
    \draw[arrow] (support) -- (sakt);
    \draw[arrow] (sakt) -- node[above, font=\small] {$\{h_i\}$} (meanpool);
    \draw[arrow] (meanpool) -- (context);
    \draw[arrow] (context) -- (protomem);
    \draw[arrow] (protomem) -- (attention);
\end{scope}

% Panel C: Parameter Generation
\node[font=\large\bfseries, anchor=west] (panelC) at (-7.5,-3.5) {(C) Parameter Generation \& Adaptation};

\begin{scope}[shift={(0,-8)}]
    % Initial parameters
    \node[protobox, text width=5cm] (thetainit) at (-4,1.5) {
        Initial Parameters\\[0.1cm]
        $\theta_{\text{init}} = \sum_{k=1}^K \alpha_k \boldsymbol{\phi}_k$
    };
    
    % Task model
    \node[adaptbox, text width=4.5cm, right=1.5cm of thetainit] (taskmodel) {
        Task-Specific\\SAKT Model\\
        $f_{\theta_{\text{init}}}$
    };
    
    % Inner loop
    \node[metabox, text width=5cm, minimum height=2cm, below=0.8cm of taskmodel] (innerloop) {
        \textbf{Inner Loop (MAML)}\\[0.2cm]
        For $t = 1, \ldots, T$:\\
        $\theta_t = \theta_{t-1} - \alpha \nabla_{\theta_{t-1}} \mathcal{L}_{\text{support}}(\theta_{t-1})$
    };
    
    % Outer loop
    \node[metabox, text width=5cm, minimum height=1.5cm, below=0.8cm of innerloop] (outerloop) {
        \textbf{Outer Loop (Meta-Update)}\\[0.2cm]
        $\mathbf{P}, \mathbf{\Phi} \leftarrow \mathbf{P}, \mathbf{\Phi} - \beta \nabla_{\mathbf{P}, \mathbf{\Phi}} \mathcal{L}_{\text{query}}(\theta')$
    };
    
    % Arrows
    \draw[arrow] (thetainit) -- (taskmodel);
    \draw[arrow] (taskmodel) -- (innerloop);
    \draw[arrow] (innerloop) -- node[right, font=\small] {$\theta'$} (outerloop);
    \draw[dashedarrow] (outerloop) -- ++(-6,0) -- ++(0,4.5) node[left, font=\small, midway] {gradient flow} -- (thetainit);
\end{scope}

% Panel D: Comparison
\node[font=\large\bfseries, anchor=west] (panelD) at (-7.5,-10) {(D) Comparison with Baselines};

\begin{scope}[shift={(0,-14)}]
    % Standard KT
    \node[text width=3cm, align=center] (std) at (-6,1.5) {\textbf{Standard KT}\\Random Init\\$\downarrow$\\Train on All Data};
    
    % Transfer Learning
    \node[text width=3cm, align=center, right=1cm of std] (transfer) {\textbf{Transfer Learning}\\Pretrain\\$\downarrow$\\Fine-tune};
    
    % MAML
    \node[text width=3cm, align=center, right=1cm of transfer] (mamlbase) {\textbf{MAML}\\Meta-Init\\$\downarrow$\\Adapt (Generic)};
    
    % Proto-KT
    \node[text width=3.5cm, align=center, right=1cm of mamlbase, fill=protogreen!10, draw=protogreen, thick, rounded corners] (protokt) {\textbf{Proto-KT (Ours)}\\Prototypes\\$\downarrow$\\Personalized Init\\$\downarrow$\\Fast Adapt};
    
    % Highlight
    \node[draw=protogreen, thick, rounded corners, fit=(protokt), inner sep=5pt] {};
\end{scope}

\end{tikzpicture}

\end{document}

